#!/usr/bin/env bash
# Arch Linux snapshot + update script
# Requires: timeshift (sudo pacman -S timeshift), yay
# Save as ~/bin/update-snapshot.sh && chmod +x

SNAPSHOT_DIR="$HOME/timeshift"  # Adjust to your Timeshift location
LOG_FILE="$HOME/update-snapshot.log"

log() { echo "[$(date)] $*" | tee -a "$LOG_FILE"; }

# Pre-update snapshot
snapshot_system() {
    log "ğŸ“¸ Creating Timeshift snapshot..."
    if sudo timeshift --create --comments "Pre-update $(date +%Y-%m-%d)" --scripted; then
        log "âœ… Snapshot created successfully"
    else
        log "âŒ Snapshot failed - aborting update"
        exit 1
    fi
}

# Full system update (pacman + AUR)
update_system() {
    log "ğŸ”„ Updating pacman repositories..."
    sudo pacman -Syu --noconfirm

    log "ğŸ”„ Updating AUR packages with yay..."
    yay -Syu --noconfirm

    log "ğŸ§¹ Cleaning package cache..."
    sudo pacman -Sc --noconfirm
    yay -Sc --noconfirm
}

# Post-update verification
verify_update() {
    log "ğŸ” Verifying system..."
    if pacman -Qk | grep -q "broken"; then
        log "âš  Some packages have broken dependencies"
    else
        log "âœ… No broken packages found"
    fi
}

main() {
    log "=== Starting snapshot + update ==="
    snapshot_system
    update_system
    verify_update
    log "=== Update complete ==="
    notify-send "System Updated" "Snapshot created + full update complete" || true
}

main "$@"
