#!/bin/bash
# Custom Arch Installer TUI - Wraps archinstall with user-friendly menus
# Uses whiptail for arrow-key navigable menus

set -eEo pipefail

# ============================================================
# VARIABLES (populated by user selections)
# ============================================================
DISK=""
HOSTNAME=""
USERNAME=""
FULLNAME=""
EMAIL=""
TIMEZONE=""
KEYMAP=""
ENCRYPT=""
USERPASS=""

# ============================================================
# HELPER FUNCTIONS
# ============================================================
msg_box() {
    whiptail --title "$1" --msgbox "$2" 10 60
}

input_box() {
    local title="$1" prompt="$2" default="${3:-}"
    whiptail --title "$title" --inputbox "$prompt" 10 60 "$default" 3>&1 1>&2 2>&3
}

password_box() {
    local title="$1" prompt="$2"
    whiptail --title "$title" --passwordbox "$prompt" 10 60 3>&1 1>&2 2>&3
}

# ============================================================
# SELECTION MENUS
# ============================================================
select_disk() {
    local disks=()
    while read -r name size model; do
        disks+=("/dev/$name" "$size $model")
    done < <(lsblk -d -n -o NAME,SIZE,MODEL | grep -E '^(nvme|sd|vd)')
    
    DISK=$(whiptail --title "Select Disk" --menu "Choose installation target:" 20 70 10 "${disks[@]}" 3>&1 1>&2 2>&3)
}

select_timezone() {
    local zones=(
        "America/New_York" "Eastern US"
        "America/Chicago" "Central US"
        "America/Denver" "Mountain US"
        "America/Los_Angeles" "Pacific US"
        "America/Anchorage" "Alaska"
        "Pacific/Honolulu" "Hawaii"
        "Europe/London" "UK"
        "Europe/Paris" "Central Europe"
        "Europe/Berlin" "Germany"
        "Asia/Tokyo" "Japan"
        "Asia/Shanghai" "China"
        "Australia/Sydney" "Australia East"
        "UTC" "UTC"
    )
    TIMEZONE=$(whiptail --title "Select Timezone" --menu "Choose your timezone:" 20 60 12 "${zones[@]}" 3>&1 1>&2 2>&3)
}

select_keymap() {
    local keymaps=(
        "us" "US English"
        "uk" "UK English"
        "de" "German"
        "fr" "French"
        "es" "Spanish"
        "it" "Italian"
        "pt" "Portuguese"
        "ru" "Russian"
        "jp106" "Japanese"
        "dvorak" "Dvorak"
        "colemak" "Colemak"
    )
    KEYMAP=$(whiptail --title "Select Keyboard Layout" --menu "Choose your keyboard layout:" 20 60 12 "${keymaps[@]}" 3>&1 1>&2 2>&3)
}

select_encryption() {
    if whiptail --title "Disk Encryption" --yesno "Enable LUKS disk encryption?\n\nThis will encrypt your root partition." 10 60; then
        ENCRYPT="y"
    else
        ENCRYPT="n"
    fi
}

# ============================================================
# MAIN MENU
# ============================================================
show_main_menu() {
    while true; do
        local choice
        choice=$(whiptail --title "Arch Linux Installer" --menu "Configure your installation:\n\nUse arrow keys to navigate, Enter to select" 22 70 12 \
            "1" "Disk:        ${DISK:-Not set}" \
            "2" "Hostname:    ${HOSTNAME:-Not set}" \
            "3" "Username:    ${USERNAME:-Not set}" \
            "4" "Full Name:   ${FULLNAME:-Not set}" \
            "5" "Email:       ${EMAIL:-Not set}" \
            "6" "Password:    ${USERPASS:+********}" \
            "7" "Timezone:    ${TIMEZONE:-Not set}" \
            "8" "Keyboard:    ${KEYMAP:-Not set}" \
            "9" "Encryption:  ${ENCRYPT:-Not set}" \
            "I" ">>> Install <<<" \
            "Q" "Quit" \
            3>&1 1>&2 2>&3) || exit 0

        case "$choice" in
            1) select_disk ;;
            2) HOSTNAME=$(input_box "Hostname" "Enter hostname:" "$HOSTNAME") ;;
            3) USERNAME=$(input_box "Username" "Enter username:" "$USERNAME") ;;
            4) FULLNAME=$(input_box "Full Name" "Enter full name (for git):" "$FULLNAME") ;;
            5) EMAIL=$(input_box "Email" "Enter email (for git):" "$EMAIL") ;;
            6)
                USERPASS=$(password_box "Password" "Enter password:")
                local pass2
                pass2=$(password_box "Confirm Password" "Confirm password:")
                if [[ "$USERPASS" != "$pass2" ]]; then
                    msg_box "Error" "Passwords do not match!"
                    USERPASS=""
                fi
                ;;
            7) select_timezone ;;
            8) select_keymap ;;
            9) select_encryption ;;
            I) run_install ;;
            Q) exit 0 ;;
        esac
    done
}

# ============================================================
# VALIDATION + INSTALL
# ============================================================
run_install() {
    local missing=()
    [[ -z "$DISK" ]] && missing+=("Disk")
    [[ -z "$HOSTNAME" ]] && missing+=("Hostname")
    [[ -z "$USERNAME" ]] && missing+=("Username")
    [[ -z "$FULLNAME" ]] && missing+=("Full Name")
    [[ -z "$EMAIL" ]] && missing+=("Email")
    [[ -z "$USERPASS" ]] && missing+=("Password")
    [[ -z "$TIMEZONE" ]] && missing+=("Timezone")
    [[ -z "$KEYMAP" ]] && missing+=("Keyboard")
    [[ -z "$ENCRYPT" ]] && missing+=("Encryption")

    if [[ ${#missing[@]} -gt 0 ]]; then
        msg_box "Missing Fields" "Please configure:\n${missing[*]}"
        return
    fi

    if ! whiptail --title "Confirm Installation" --yesno "Ready to install:\n\nDisk: $DISK\nHostname: $HOSTNAME\nUser: $USERNAME\nTimezone: $TIMEZONE\nKeyboard: $KEYMAP\nEncryption: $ENCRYPT\n\nWARNING: $DISK will be ERASED!" 18 60; then
        return
    fi

    loadkeys "$KEYMAP" 2>/dev/null || true
    generate_config
    archinstall --config /tmp/archinstall.json --creds /tmp/creds.json
    post_install
    msg_box "Complete" "Installation finished!\nRemove USB and reboot."
}

generate_config() {
    cat > /tmp/archinstall.json <<EOF
{
    "config_version": "2.6.0",
    "hostname": "$HOSTNAME",
    "timezone": "$TIMEZONE",
    "keyboard-layout": "$KEYMAP",
    "kernels": ["linux-zen"],
    "bootloader": "limine",
    "audio_config": {"audio": "pipewire"},
    "disk_config": {
        "config_type": "default_layout",
        "device_modifications": [{"device": "$DISK", "wipe": true}]
    },
    "disk_encryption": $(if [[ "$ENCRYPT" == "y" ]]; then echo '{"encryption_type": "luks"}'; else echo 'null'; fi),
    "swap": false,
    "nic": {"type": "nm"}
}
EOF

    cat > /tmp/creds.json <<EOF
{"!users": [{"username": "$USERNAME", "!password": "$USERPASS", "sudo": true}]}
EOF
}

post_install() {
    local root_dev="${DISK}p2"
    [[ "$DISK" =~ ^/dev/sd ]] && root_dev="${DISK}2"
    [[ "$ENCRYPT" == "y" ]] && root_dev="/dev/mapper/cryptroot"

    mount "$root_dev" /mnt 2>/dev/null || true
    arch-chroot /mnt /bin/bash <<CHROOT
su - $USERNAME -c "git config --global user.name \"$FULLNAME\""
su - $USERNAME -c "git config --global user.email \"$EMAIL\""
CHROOT
    umount /mnt 2>/dev/null || true
}

# ============================================================
# ENTRY POINT
# ============================================================
clear
msg_box "Welcome" "Welcome to the Custom Arch Installer!\n\nThis will install Arch Linux with:\n- linux-zen kernel\n- Limine bootloader\n- Btrfs filesystem\n- Optional encryption"

show_main_menu

