#!/bin/bash
# Custom Arch Installer TUI using gum
# Front-end for archinstall (linux-zen + Limine + Btrfs + optional LUKS)

set -eEo pipefail

# -----------------------------
# State
# -----------------------------
DISK=""
HOSTNAME=""
USERNAME=""
FULLNAME=""
EMAIL=""
TIMEZONE=""
KEYMAP=""
ENCRYPT=""   # "Yes"/"No"
USERPASS=""

# -----------------------------
# Helpers
# -----------------------------
pause() { gum confirm "Continue?" >/dev/null || exit 1; }

banner() {
  gum style --border normal --margin "1 2" --padding "1 2" \
    --border-foreground 212 "$(cat <<'EOF'
   ▄████████     ███        ▄████████  ▄█  ▀████    ▐████▀ 
  ███    ███ ▀█████████▄   ███    ███ ███    ███▌   ████▀  
  ███    █▀     ▀███▀▀██   ███    ███ ███▌    ███  ▐███    
  ███            ███   ▀  ▄███▄▄▄▄██▀ ███▌    ▀███▄███▀    
▀███████████     ███     ▀▀███▀▀▀▀▀   ███▌    ████▀██▄     
         ███     ███     ▀███████████ ███    ▐███  ▀███    
   ▄█    ███     ███       ███    ███ ███   ▄███     ███▄  
 ▄████████▀     ▄████▀     ███    ███ █▀   ████       ███▄ 
                           ███    ███                      
EOF
)"
}

summary() {
  gum style --margin "1 2" --padding "0 2" --border normal --border-foreground 240 \
"Disk:       ${DISK:-<not set>}
Hostname:   ${HOSTNAME:-<not set>}
Username:   ${USERNAME:-<not set>}
Full name:  ${FULLNAME:-<not set>}
Email:      ${EMAIL:-<not set>}
Timezone:   ${TIMEZONE:-<not set>}
Keymap:     ${KEYMAP:-<not set>}
Encryption: ${ENCRYPT:-<not set>}"
}

# -----------------------------
# Input sections
# -----------------------------
pick_disk() {
  echo "Scanning disks..."

  # Always get full /dev paths (-p / --paths behavior) so later lsblk calls work
  mapfile -t disk_lines < <(lsblk -dpno NAME,SIZE,MODEL | grep -E '^/dev/(nvme|sd|vd)')

  ((${#disk_lines[@]})) || { gum style --foreground 196 "No disks found."; return 1; }

  local choices=()
  for line in "${disk_lines[@]}"; do
    local disk size model
    disk=$(awk '{print $1}' <<<"$line")
    size=$(awk '{print $2}' <<<"$line")
    model=$(cut -d' ' -f3- <<<"$line")

    # Build an OS hint based on partition FS types
    local os_hint="Empty"
    while read -r p fstype _; do
      case "$fstype" in
        ntfs) os_hint="Windows" ;;
        vfat) [[ "$os_hint" == "Empty" ]] && os_hint="EFI/Boot" ;;
        ext4|ext3|btrfs|xfs|f2fs) [[ "$os_hint" != "Windows" ]] && os_hint="Linux" ;;
      esac
    done < <(lsblk -pnro NAME,FSTYPE "$disk" | tail -n +2)

    local part_count
    part_count=$(lsblk -pnro NAME "$disk" | tail -n +2 | wc -l)

    choices+=("$disk  ($size)  $model  |  $part_count partitions  |  $os_hint")
  done

  local sel
  sel=$(printf '%s\n' "${choices[@]}" | gum choose --height 12 --header "Select installation disk (will be wiped)")
  DISK=$(awk '{print $1}' <<<"$sel")

  # Show a detailed preview for confirmation
  local detail
  detail=$(lsblk -p -o NAME,SIZE,FSTYPE,LABEL,MOUNTPOINT,PARTTYPE "$DISK")
  gum style --border normal --padding "1 2" "$detail"

  gum confirm "ERASE ALL DATA ON $DISK and continue?" --default=false || { DISK=""; return 1; }
}

pick_timezone() {
  mapfile -t choices <<EOF
America/New_York  [Eastern US]
America/Chicago   [Central US]
America/Denver    [Mountain US]
America/Los_Angeles [Pacific US]
America/Anchorage [Alaska]
Pacific/Honolulu  [Hawaii]
Europe/London     [UK]
Europe/Paris      [Central Europe]
Europe/Berlin     [Germany]
Asia/Tokyo        [Japan]
Asia/Shanghai     [China]
Australia/Sydney  [Australia East]
UTC               [UTC]
EOF

  sel=$(printf '%s\n' "${choices[@]}" | gum choose --height 12 --header "Select timezone")
  TIMEZONE=${sel%% *}
}

pick_keymap() {
  mapfile -t choices <<EOF
us       [US English]
uk       [UK English]
de       [German]
fr       [French]
es       [Spanish]
it       [Italian]
pt       [Portuguese]
ru       [Russian]
jp106    [Japanese]
dvorak   [Dvorak]
colemak  [Colemak]
EOF

  sel=$(printf '%s\n' "${choices[@]}" | gum choose --height 12 --header "Select keyboard layout")
  KEYMAP=${sel%% *}
}

pick_encryption() {
  ENCRYPT=$(printf '%s\n' "Yes" "No" | gum choose --header "Enable LUKS encryption for root?")
}

enter_strings() {
  HOSTNAME=$(gum input --placeholder "Hostname" --value "${HOSTNAME:-}" --header "Enter hostname")
  USERNAME=$(gum input --placeholder "Username" --value "${USERNAME:-}" --header "Enter username")
  FULLNAME=$(gum input --placeholder "Full name (for git)" --value "${FULLNAME:-}" --header "Enter full name")
  EMAIL=$(gum input --placeholder "Email (for git)" --value "${EMAIL:-}" --header "Enter email")
}

enter_password() {
  while true; do
    p1=$(gum input --password --header "Enter password for $USERNAME")
    p2=$(gum input --password --header "Confirm password")
    [[ "$p1" == "$p2" ]] && { USERPASS="$p1"; break; }
    gum style --foreground 196 "Passwords do not match, try again."
  done
}

# -----------------------------
# Config + install
# -----------------------------
generate_config() {
  # Basic archinstall JSON (uses default layout, Linux-zen, Limine, no swap)
  cat > /tmp/archinstall.json <<EOF
{
  "config_version": "3.1.5",
  "hostname": "$HOSTNAME",
  "timezone": "$TIMEZONE",
  "keyboard-layout": "$KEYMAP",
  "kernels": ["linux-zen"],
  "bootloader": "limine",
  "audio_config": { "audio": "pipewire" },
  "disk_config": {
    "config_type": "default_layout",
    "device_modifications": [
      { "device": "$DISK", "wipe": true }
    ]
  },
  "disk_encryption": $( [[ "$ENCRYPT" == "Yes" ]] && \
    echo '{"encryption_type": "luks"}' || echo "null"),
  "swap": false,
  "nic": { "type": "nm" }
}
EOF

  cat > /tmp/creds.json <<EOF
{
  "!users": [
    {
      "username": "$USERNAME",
      "!password": "$USERPASS",
      "sudo": true
    }
  ]
}
EOF
}

post_install() {
  # crude but works for your layout: root partition = second partition or cryptroot
  if [[ "$ENCRYPT" == "Yes" ]]; then
    ROOT_DEV="/dev/mapper/cryptroot"
  else
    ROOT_DEV="${DISK}p2"
    [[ "$DISK" =~ ^/dev/sd ]] && ROOT_DEV="${DISK}2"
  fi

  mount "$ROOT_DEV" /mnt 2>/dev/null || true
  arch-chroot /mnt /bin/bash <<CHROOT
su - "$USERNAME" -c "git config --global user.name \"$FULLNAME\""
su - "$USERNAME" -c "git config --global user.email \"$EMAIL\""
echo "KEYMAP=$KEYMAP" > /etc/vconsole.conf
CHROOT
  umount /mnt 2>/dev/null || true
}

run_install() {
  # validate
  missing=()
  [[ -z "$DISK" ]]      && missing+=("disk")
  [[ -z "$HOSTNAME" ]]  && missing+=("hostname")
  [[ -z "$USERNAME" ]]  && missing+=("username")
  [[ -z "$FULLNAME" ]]  && missing+=("full name")
  [[ -z "$EMAIL" ]]     && missing+=("email")
  [[ -z "$USERPASS" ]]  && missing+=("password")
  [[ -z "$TIMEZONE" ]]  && missing+=("timezone")
  [[ -z "$KEYMAP" ]]    && missing+=("keymap")
  [[ -z "$ENCRYPT" ]]   && missing+=("encryption choice")

  if (( ${#missing[@]} )); then
    gum style --foreground 196 "Missing: ${missing[*]}"
    pause
    return
  fi

  clear
  banner
  summary
  echo
  gum confirm "Proceed with installation and ERASE $DISK ?" || return

  loadkeys "$KEYMAP" 2>/dev/null || true

  gum spin --title "Generating config..." -- generate_config
  gum spin --title "Running archinstall..." -- archinstall --config /tmp/archinstall.json --creds /tmp/creds.json
  gum spin --title "Post-install configuration..." -- post_install

  clear
  banner
  gum style --foreground 46 "Installation complete. Reboot into your new system."
}

spin_fn() {
  local title="$1"
  local fn="$2"
  export DISK HOSTNAME USERNAME FULLNAME EMAIL TIMEZONE KEYMAP ENCRYPT USERPASS
  export -f "$fn"
  gum spin --title "$title" -- bash -c "$fn"
}


view_archinstall_json() {
  spin_fn "Generating config..." generate_config

  [[ -s /tmp/archinstall.json ]] || {
    gum style --foreground 196 "Missing /tmp/archinstall.json (generate_config didn't create it)."
    pause
    return 1
  }

  gum style --border normal --padding "0 1" "archinstall config: /tmp/archinstall.json"

  if command -v jq >/dev/null 2>&1; then
    jq . /tmp/archinstall.json > /tmp/archinstall.pretty.json
    gum pager < /tmp/archinstall.pretty.json
  else
    gum pager < /tmp/archinstall.json
  fi

  pause
}

view_creds_json() {
  spin_fn "Generating config..." generate_config

  [[ -s /tmp/creds.json ]] || {
    gum style --foreground 196 "Missing /tmp/creds.json (generate_config didn't create it)."
    pause
    return 1
  }

  if command -v jq >/dev/null 2>&1; then
    jq . /tmp/creds.json | gum pager --header "creds: /tmp/creds.json"
  else
    gum pager --header "creds: /tmp/creds.json" < /tmp/creds.json
  fi

  pause
}

# -----------------------------
# Main wizard
# -----------------------------
main_menu() {
  while true; do
    clear
    banner
    summary
    echo

choice=$(printf '%s\n' \
  "Disk" "Hostname/User/Git" "Timezone" "Keyboard" "Encryption" "Password" \
  "View archinstall JSON" "View creds JSON" \
  "Install" "Quit" \
| gum choose --header "Select an item to edit:")
case "$choice" in
  "Disk") pick_disk ;;
  "Hostname/User/Git") enter_strings ;;
  "Timezone") pick_timezone ;;
  "Keyboard") pick_keymap ;;
  "Encryption") pick_encryption ;;
  "Password") enter_password ;;
  "View archinstall JSON") view_archinstall_json ;;
  "View creds JSON") view_creds_json ;;
  "Install") run_install ;;
  "Quit") exit 0 ;;
esac
  done
}

# -----------------------------
# Entry
# -----------------------------
clear
banner
gum style "This wizard will install Arch Linux with:" \
  "\n- linux-zen kernel" \
  "\n- Limine bootloader" \
  "\n- Btrfs (via archinstall default layout)" \
  "\n- Optional LUKS encryption"
pause

main_menu

